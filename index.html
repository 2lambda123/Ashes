<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <link rel="stylesheet" type="text/css" href="res/css/main.css" />
        <link href="https://unpkg.com/nes.css/css/nes.min.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <title>Ashes</title>
    </head>
    <body>
        <canvas id="screen"></canvas>
        <section class="nes-container with-title">
            <h2 class="title">PROGRESS</h2>
            <progress id="progress" class="nes-progress" value="1" max="1"></progress>
        </section>
    </body>
    <script src="https://cdn.jsdelivr.net/npm/ashes3d@0.0.12/build/ashes.main.js"></script>
    <!-- <script src="build/ashes.main.js"></script> -->
    <script>
        console.log(Ashes);


        async function run() {
            let progressBar = document.querySelector('#progress');
            Ashes.Asset.taskObserve = (finished, total) => {
                let p = finished/total;
                progressBar.value = p;
            }
            let gltf = '/gltfsamples/BoxTextured/BoxTextured.gltf';
            // gltf = '/static/gltfsamples/Suzanne/Suzanne.gltf';
            gltf = '/gltfsamples/toon_shader_tutorial_files/scene.gltf';
            // gltf = '/static/gltfsamples/nierautomata__2b/scene.gltf';
            // gltf = '/static/gltfsamples/sketchfab_3d_editor_challenge_littlest_tokyo/scene.gltf';
            // gltf = '/static/gltfsamples/hylian_shield/scene.gltf';
            gltf = '/gltfsamples/FlightHelmet/glTF/FlightHelmet.gltf';
            gltf = 'gltfsamples/police_drone/scene.gltf';

            let [,cuspath,scale, yoffset] = location.hash.split('#');
            if(cuspath)
                gltf = cuspath;

            let screen = new Ashes.Screen('#screen');

            let scene = Ashes.EntityMgr.create('root');
            let gltfroot = await Ashes.Asset.loadGLTF(gltf, screen, 'res/envmap/GoldenGateBridge2/');
            scene.appendChild(gltfroot);
            progressBar.parentElement.style.display = 'none';
            let root = gltfroot.components.Transform;
            if(yoffset)
                root.translate[1] = yoffset;
            if(scale)
                root.scale[0] = root.scale[1] = root.scale[2] = scale;


            let mainCamera = Ashes.EntityMgr.create('camera');
            let cameraTrans = mainCamera.components.Transform;
            let cam = Ashes.EntityMgr.addComponent(mainCamera, new Ashes.Camera(screen.width / screen.height));
            Ashes.vec3.set(cameraTrans.translate, 0, 0, 10);

            scene.appendChild(mainCamera);
            let control = new Ashes.OrbitControl(screen, mainCamera);

            // IBL test
            let testmat = await Ashes.Asset.LoadMaterial('test');
            // let brdfLUT = await Ashes.Asset.loadImage('https://raw.githubusercontent.com/KhronosGroup/glTF-WebGL-PBR/master/textures/brdfLUT.png');
            // let map = await Ashes.Asset.loadCubemap('res/GoldenGateBridge2/');

            // Ashes.Material.setTexture(testmat, 'brdfLUT', new Ashes.Texture(brdfLUT, { minFilter: screen.gl.LINEAR }));
            // Ashes.Material.setTexture(testmat, 'baseColorTexture', Ashes.MeshRendererSystem);

            // let quad = Ashes.EntityMgr.create('test-quad');
            // let qmesh = new Ashes.QuadMesh();
            // let quadMR = new Ashes.MeshRenderer(screen, qmesh, testmat);
            // Ashes.EntityMgr.addComponent(quad, quadMR);
            // console.log(quadMR);
            // quad.components.Transform.translate[0] = 2;

            // scene.appendChild(quad);

            document.querySelector('body').appendChild(scene);



        }

        run();




    </script>
</html>
